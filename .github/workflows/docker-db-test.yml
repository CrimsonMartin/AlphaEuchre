name: Docker Database Test

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'docker-compose.yml'
      - 'database/**'
      - 'services/db-migrations/**'
      - '.github/workflows/docker-db-test.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'docker-compose.yml'
      - 'database/**'
      - 'services/db-migrations/**'
      - '.github/workflows/docker-db-test.yml'

jobs:
  test-database-init:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build and start postgres container
      run: |
        docker-compose build postgres
        docker-compose up -d postgres
    
    - name: Wait for postgres to be healthy
      run: |
        echo "Waiting for postgres to be healthy..."
        timeout 60 bash -c 'until docker-compose exec -T postgres pg_isready -U euchre -d euchrebot; do sleep 2; done'
        echo "Postgres is ready!"
    
    - name: Verify all 10 tables are created
      run: |
        echo "Checking database tables..."
        
        # Get table count
        TABLE_COUNT=$(docker-compose exec -T postgres psql -U euchre -d euchrebot -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public' AND table_type = 'BASE TABLE';")
        TABLE_COUNT=$(echo $TABLE_COUNT | tr -d ' ')
        
        echo "Found $TABLE_COUNT tables"
        
        if [ "$TABLE_COUNT" -ne "10" ]; then
          echo "ERROR: Expected 10 tables, found $TABLE_COUNT"
          docker-compose exec -T postgres psql -U euchre -d euchrebot -c "\dt"
          exit 1
        fi
        
        echo "✓ Table count verified: 10 tables"
    
    - name: Verify each required table exists
      run: |
        REQUIRED_TABLES=(
          "ai_models"
          "game_states"
          "games"
          "hands"
          "moves"
          "players"
          "training_games"
          "training_logs"
          "training_runs"
          "tricks"
        )
        
        echo "Verifying required tables..."
        
        for table in "${REQUIRED_TABLES[@]}"; do
          EXISTS=$(docker-compose exec -T postgres psql -U euchre -d euchrebot -t -c "SELECT EXISTS (SELECT FROM information_schema.tables WHERE table_schema = 'public' AND table_name = '$table');")
          EXISTS=$(echo $EXISTS | tr -d ' ')
          
          if [ "$EXISTS" != "t" ]; then
            echo "ERROR: Table '$table' does not exist!"
            exit 1
          fi
          echo "✓ Table '$table' exists"
        done
        
        echo ""
        echo "All required tables verified successfully!"
    
    - name: Verify ai_models table structure
      run: |
        echo "Verifying ai_models table structure..."
        
        # Check for required columns
        REQUIRED_COLUMNS=(
          "id"
          "name"
          "version"
          "architecture"
          "generation"
          "elo_rating"
          "model_path"
          "active"
        )
        
        for column in "${REQUIRED_COLUMNS[@]}"; do
          EXISTS=$(docker-compose exec -T postgres psql -U euchre -d euchrebot -t -c "SELECT EXISTS (SELECT FROM information_schema.columns WHERE table_name = 'ai_models' AND column_name = '$column');")
          EXISTS=$(echo $EXISTS | tr -d ' ')
          
          if [ "$EXISTS" != "t" ]; then
            echo "ERROR: Column '$column' does not exist in ai_models table!"
            exit 1
          fi
          echo "✓ Column 'ai_models.$column' exists"
        done
        
        echo ""
        echo "ai_models table structure verified!"
    
    - name: Verify indexes are created
      run: |
        echo "Verifying indexes..."
        
        INDEX_COUNT=$(docker-compose exec -T postgres psql -U euchre -d euchrebot -t -c "SELECT COUNT(*) FROM pg_indexes WHERE schemaname = 'public';")
        INDEX_COUNT=$(echo $INDEX_COUNT | tr -d ' ')
        
        echo "Found $INDEX_COUNT indexes"
        
        # We expect at least 12 indexes (10 primary keys + custom indexes)
        if [ "$INDEX_COUNT" -lt "12" ]; then
          echo "WARNING: Expected at least 12 indexes, found $INDEX_COUNT"
          docker-compose exec -T postgres psql -U euchre -d euchrebot -c "SELECT indexname FROM pg_indexes WHERE schemaname = 'public';"
        fi
        
        echo "✓ Index verification complete"
    
    - name: Print database summary
      if: always()
      run: |
        echo "=== Database Summary ==="
        docker-compose exec -T postgres psql -U euchre -d euchrebot -c "\dt" || true
        echo ""
        echo "=== Postgres Logs ==="
        docker-compose logs postgres | tail -50 || true
    
    - name: Cleanup
      if: always()
      run: |
        docker-compose down -v
